<html>

<head>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fluig-style-guide/css/fluig-style-guide.min.css">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
	<link rel="stylesheet" href="./style.css">
	<link rel="stylesheet" href="https://fluig.elcop.eng.br:8443/style-guide/css/fluig-style-guide.min.css">
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js" charset="utf-8"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js" charset="utf-8"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
	<script type="text/javascript" src="/webdesk/vcXMLRPC.js"></script>
	<script src="./script.js"></script>
	<script src="./functions.js"></script>
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>
	<div class="fluig-style-guide">
		<form name="form" role="form">

			<!-- Header -->
			<div class="card">
				<div class="card-body">
					<div class="row">
						<div class="form-group col-md-6 css_header_img" style="margin-left: 1rem;">
							<img src="./elcop_nossa_energia.png" alt="Logo Elcop" width="329" height="194">
							<label class="css_header_text">Lançamentos de Descontos</label>
						</div>
					</div>
				</div>
			</div>

			<!-- Ocultos gerais / integração -->
			<input type="hidden" name="statusIntegracao" id="statusIntegracao" value="NOK">
			<!-- campos auxiliares para payloads complexos -->
			<input type="hidden" name="parcelas_json" id="parcelas_json" value="">
			<input type="hidden" name="confirmacao_tipo" id="confirmacao_tipo" value="">
			<input type="hidden" name="confirmacao_motivoRecusa" id="confirmacao_motivoRecusa" value="">
			<input type="hidden" name="assinaturaFuncionario_base64" id="assinaturaFuncionario_base64" value="">
			<input type="hidden" name="assinaturaTestemunha1_base64" id="assinaturaTestemunha1_base64" value="">
			<input type="hidden" name="assinaturaTestemunha2_base64" id="assinaturaTestemunha2_base64" value="">
			<input type="hidden" name="evidencias_json" id="evidencias_json" value="">
			<!-- opcional: id de anexo gerado (foto/pdf) se quiser rastrear -->
			<input type="hidden" name="anexo_foto_nome" id="anexo_foto_nome" value="">
			<input type="hidden" name="anexo_pdf_nome" id="anexo_pdf_nome" value="">

			<!-- Integração Protheus - status detalhado -->
			<input type="hidden" name="integ_aberto_status" id="integ_aberto_status" value="">
			<input type="hidden" name="integ_aberto_msg" id="integ_aberto_msg" value="">
			<input type="hidden" name="integ_aberto_payload" id="integ_aberto_payload" value="">

			<input type="hidden" name="integ_futuro_status" id="integ_futuro_status" value="">
			<input type="hidden" name="integ_futuro_msg" id="integ_futuro_msg" value="">
			<input type="hidden" name="integ_futuro_payload" id="integ_futuro_payload" value="">

			<!-- Opcional: resumo único -->
			<input type="hidden" name="integ_resumo" id="integ_resumo" value="">

			<input type="hidden" name="timeAtividadeAtual" id="timeAtividadeAtual" readonly>
			<input type="hidden" name="atividadeAtual" id="atividadeAtual" readonly>
			<input type="hidden" name="timeInicioProcesso" id="timeInicioProcesso" readonly>
			<input type="hidden" name="timeFimProcesso" id="timeFimProcesso" readonly>

			<input type="hidden" name="grupoAprovadorCC" id="grupoAprovadorCC" readonly>
			<input type="hidden" name="qtdEmailsEnviados" id="qtdEmailsEnviados" readonly value="1">

			<input type="hidden" name="dataHoraAssinaturaFunc" id="dataHoraAssinaturaFunc">
			<input type="hidden" name="recusaAssinatura" id="recusaAssinatura">

			<input type="hidden" name="descontoAtivo" id="descontoAtivo" value="">

			<!-- Dados do Solicitante -->
			<div class="panel panel-primary">
				<div class="panel-heading">
					<h5 class="panel-title">Dados do Solicitante</h5>
				</div>
				<div class="panel-body">
					<div class="row">
						<div class="form-group col-md-4">
							<label>Número do Fluig</label>
							<input type="text" class="form-control" name="solicitacao_fluig" id="solicitacao_fluig"
								readonly>
						</div>
						<div class="form-group col-md-4">
							<label>Data Solicitação</label>
							<input type="text" name="dataSolicitacao" class="form-control" readonly>
						</div>
						<div class="form-group col-md-4">
							<label>Hora Solicitação</label>
							<input type="text" name="horaSolicitacao" class="form-control" readonly>
						</div>
					</div>
					<div class="row">
						<div class="form-group col-md-4">
							<label>Nome do Solicitante</label>
							<input type="text" name="nomeSolicitante" class="form-control" readonly>
						</div>
						<div class="form-group col-md-4">
							<label>Matrícula do Solicitante</label>
							<input type="text" name="matriculaSolicitante" class="form-control" readonly>
						</div>
						<div class="form-group col-md-4">
							<label>E-mail do Solicitante</label>
							<input type="text" name="emailSolicitante" class="form-control" readonly>
						</div>
					</div>
				</div>
			</div>

			<!-- Novos descontos -->
			<div class="panel panel-primary">
				<div class="panel-heading">
					<h5 class="panel-title">Novo Desconto</h5>
				</div>
				<div class="panel-body">
					<div class="row">
						<div class="form-group col-md-3">
							<label>Matrícula do Colaborador</label>
							<input type="text" name="matriculaColaborador" class="form-control" readonly>
						</div>
						<div class="form-group col-md-3">
							<label>Nome do Colaborador</label>
							<input type="text" name="nomeColaborador" class="form-control" readonly>
						</div>
						<div class="form-group col-md-3">
							<label>Salário Bruto</label>
							<input type="text" name="valSalario" class="form-control" readonly>
						</div>
						<div class="form-group col-md-3">
							<label>15% do Salário Bruto</label>
							<input type="text" name="salarioporcento" class="form-control" readonly>
						</div>
					</div>

					<div class="row">
						<div class="form-group col-md-3">
							<label>Filial</label>
							<input type="text" name="codFilial" class="form-control" readonly>
						</div>
						<div class="form-group col-md-3">
							<label>Descrição</label>
							<input type="text" name="descricao" class="form-control" readonly>
						</div>
						<div class="form-group col-md-3">
							<label>Valor</label>
							<input type="text" name="valorEpi" class="form-control" readonly>
						</div>
						<div class="form-group col-md-3">
							<label>Total de Parcelas</label>
							<input type="text" name="totalParcelas" class="form-control" readonly>
						</div>
					</div>
					<div class="row">
						<div class="form-group col-md-3">
							<label>Tipo</label>
							<input type="text" name="tipoDesconto" class="form-control" readonly>
						</div>
						<div class="form-group col-md-3">
							<label>Verba</label>
							<input type="text" name="codVerba" class="form-control" readonly>
						</div>
						<div class="form-group col-md-3">
							<label>Tipo Verba</label>
							<input type="text" name="tipoVerba" class="form-control" readonly>
						</div>
						<div class="form-group col-md-3">
							<label>Período Atual</label>
							<input type="text" name="periodoAtual" class="form-control" readonly>
						</div>
					</div>
				</div>
			</div>

			<!-- Parcelas (espelho do que foi calculado na widget) -->
			<div class="panel panel-default">
				<div class="panel-heading">
					<h5 class="panel-title">Parcelas Geradas</h5>
				</div>
				<div class="panel-body">
					<div class="table-responsive">
						<table class="table table-bordered table-striped" id="tabelaParcelasForm">
							<thead>
								<tr>
									<th style="width:140px;">Período (YYYYMM)</th>
									<th style="width:180px;">Valor da Parcela (R$)</th>
								</tr>
							</thead>
							<tbody>
								<!-- linhas são preenchidas pelo motor do Fluig a partir de parcelas_json (opcional) -->
							</tbody>
							<tfoot>
								<tr>
									<th>Total</th>
									<th><input type="text" name="parcelas_total" id="parcelas_total"
											class="form-control" readonly></th>
								</tr>
							</tfoot>
						</table>
					</div>
					<small class="text-muted">Campo técnico: <code>parcelas_json</code> contém as parcelas em formato
						JSON.</small>
				</div>
			</div>

			<!-- Confirmação / Recusa -->
			<div class="panel panel-default">
				<div class="panel-heading">
					<h5 class="panel-title">Confirmação</h5>
				</div>
				<div class="panel-body">
					<div class="row">
						<div class="form-group col-md-4">
							<label>Tipo de Confirmação</label>
							<input type="text" class="form-control" name="confirmacao_tipo_view"
								id="confirmacao_tipo_view" readonly>
							<!-- valores esperados: ASSINATURA_FUNC | RECUSA_TESTEMUNHAS -->
						</div>
						<div class="form-group col-md-8">
							<label>Motivo da Recusa (se houver)</label>
							<input type="text" class="form-control" name="confirmacao_motivoRecusa_view"
								id="confirmacao_motivoRecusa_view" readonly>
						</div>
					</div>
				</div>
			</div>

			<!-- Assinatura do Funcionário (imagem base64) -->
			<div class="panel panel-default">
				<div class="panel-heading">
					<h5 class="panel-title">Assinatura do Funcionário</h5>
				</div>
				<div class="panel-body">
					<div class="row">
						<div class="col-md-12">
							<img id="assinaturaFuncionario_img" src="" alt="Assinatura do Funcionário"
								style="max-width:100%; border:1px solid #ddd;">
							<small class="text-muted">Campo técnico: <code>assinaturaFuncionario_base64</code></small>
						</div>
					</div>
				</div>
			</div>

			<!-- Testemunha 1 -->
			<div class="panel panel-default">
				<div class="panel-heading">
					<h5 class="panel-title">Testemunha 1</h5>
				</div>
				<div class="panel-body">
					<div class="row">
						<div class="form-group col-md-4">
							<label>Nome</label>
							<input type="text" name="test1_nome" id="test1_nome" class="form-control" readonly>
						</div>
						<div class="form-group col-md-4">
							<label>CPF</label>
							<input type="text" name="test1_cpf" id="test1_cpf" class="form-control" readonly>
						</div>
						<div class="form-group col-md-4">
							<label>Cargo/Setor</label>
							<input type="text" name="test1_cargo" id="test1_cargo" class="form-control" readonly>
						</div>
					</div>
					<div class="row" style="margin-top:8px;">
						<div class="col-md-12">
							<img id="assinaturaTestemunha1_img" src="" alt="Assinatura Testemunha 1"
								style="max-width:100%; border:1px solid #ddd;">
							<small class="text-muted">Campo técnico: <code>assinaturaTestemunha1_base64</code></small>
						</div>
					</div>
				</div>
			</div>

			<!-- Testemunha 2 -->
				<div class="panel panel-default">
				<div class="panel-heading">
					<h5 class="panel-title">Testemunha 2</h5>
				</div>
				<div class="panel-body">
					<div class="row">
						<div class="form-group col-md-4">
							<label>Nome</label>
							<input type="text" name="test2_nome" id="test2_nome" class="form-control" readonly>
						</div>
						<div class="form-group col-md-4">
							<label>CPF</label>
							<input type="text" name="test2_cpf" id="test2_cpf" class="form-control" readonly>
						</div>
						<div class="form-group col-md-4">
							<label>Cargo/Setor</label>
							<input type="text" name="test2_cargo" id="test2_cargo" class="form-control" readonly>
						</div>
					</div>
					<div class="row" style="margin-top:8px;">
						<div class="col-md-12">
							<img id="assinaturaTestemunha2_img" src="" alt="Assinatura Testemunha 2"
								style="max-width:100%; border:1px solid #ddd;">
							<small class="text-muted">Campo técnico: <code>assinaturaTestemunha2_base64</code></small>
						</div>
					</div>
				</div>
			</div>

			<!-- Foto e Evidências -->
			<div class="panel panel-default">
				<div class="panel-heading">
					<h5 class="panel-title">Evidências</h5>
				</div>
				<div class="panel-body">
					<div class="row">
						<div class="form-group col-md-6">
							<label>Foto do Funcionário</label>
							<div id="fotoFuncionario_container">
								<!-- imagem opcional via anexo: o processo pode renderizar com link -->
								<span class="text-muted">Foto anexada ao processo.</span>
							</div>
							<small class="text-muted">Nome do anexo (opcional): <code>anexo_foto_nome</code></small>
						</div>
						<div class="form-group col-md-6">
							<label>Relatório (PDF)</label>
							<div id="pdfRelatorio_container">
								<span class="text-muted">PDF anexado ao processo.</span>
							</div>
							<small class="text-muted">Nome do anexo (opcional): <code>anexo_pdf_nome</code></small>
						</div>
					</div>

					<div class="row" style="margin-top:10px;">
						<div class="form-group col-md-12">
							<label>Outras Evidências (lista)</label>
							<textarea name="evidencias_json_view" id="evidencias_json_view" class="form-control"
								rows="3" readonly></textarea>
							<small class="text-muted">Campo técnico: <code>evidencias_json</code> com base64/links das
								evidências extras.</small>
						</div>
					</div>
				</div>
			</div>

			<div class="css_nav_margin" id="aba_aprovacao_gerente">
				<br />
				<div class="panel panel-default">
					<div class="panel-body">
						<br>
						<div class="row">
							<div class="form-group col-md-6">
								<h4 class="card-title">Aprovar Desconto?<span
										class="required text-danger"><strong>
											*</strong></span></h4>
								<div class="input-group">
									<div class="custom-radio custom-radio-inline custom-radio-success">
										<input type="radio" name="rdAprovaDescGerente"
											id="rdAprovaDescGerente_descontar" value="descontar">
										<label for="rdAprovaDescGerente_descontar"><strong>Sim</strong>,
											aprovar desconto</label>
									</div>
									<div class="custom-radio custom-radio-inline custom-radio-danger">
										<input type="radio" name="rdAprovaDescGerente"
											id="rdAprovaDescGerente_abonar" value="abonar">
										<label for="rdAprovaDescGerente_abonar"><strong>Não</strong>,
											abonar desconto</label>
									</div>
								</div>
							</div>
						</div>
						<div class="row">
							<div class="form-group col-md-12">
								<label for="obsAnaliseAprovadorGerente">Observação do Aprovador
									<span class="required text-danger"><strong>
											*</strong></span></label>
								<textarea rows="4" class="form-control" name="obsAnaliseAprovadorGerente"
									id="obsAnaliseAprovadorGerente" maxlength="300"></textarea>
							</div>
						</div>
					</div>
				</div>
			</div>

			<!-- <div class="panel panel-default" id="panelTestemunha2">
				<div class="panel-heading">
					<h5 class="panel-title">Testemunha 2</h5>
				</div>
				<div class="panel-body">
					<div class="row">
						<div class="form-group col-md-4">
							<label>Nome</label>
							<input type="text" name="test2_nome" id="test2_nome" class="form-control" readonly>
						</div>
						<div class="form-group col-md-4">
							<label>CPF</label>
							<input type="text" name="test2_cpf" id="test2_cpf" class="form-control">
						</div>
						<div class="form-group col-md-4">
							<label>Cargo/Setor</label>
							<input type="text" name="test2_cargo" id="test2_cargo" class="form-control">
						</div>
					</div>
					<div class="row" style="margin-top:8px;">
						<div class="col-md-8">
							<label>Assinatura</label>
								<canvas id="signature-pad-test2"
									style="border:1px solid #ccc; width:100%; height:120px;"></canvas>
								<button class="btn btn-danger"
									onclick="clearPad('signature-pad-test2')">Limpar</button>
						</div>
						<div class="col-md-12">
							 <img id="assinaturaTestemunha2_img" src="" alt="Assinatura Testemunha 2"
								style="max-width:100%; border:1px solid #ddd;"> -->
							<!-- <small class="text-muted">Campo técnico: <code>assinaturaTestemunha2_base64</code></small>
						</div>
					</div>
				</div>
			</div> -->

		</form>
	</div>

	<script>
		// Renderização básica das imagens de assinatura a partir dos campos base64, se vierem preenchidos
		(function hydrateImagesFromBase64() {
			const f = document.getElementById('assinaturaFuncionario_base64')?.value || '';
			if (f) document.getElementById('assinaturaFuncionario_img').src = 'data:image/png;base64,' + f;

			const t1 = document.getElementById('assinaturaTestemunha1_base64')?.value || '';
			if (t1) document.getElementById('assinaturaTestemunha1_img').src = 'data:image/png;base64,' + t1;

			const t2 = document.getElementById('assinaturaTestemunha2_base64')?.value || '';
			if (t2) document.getElementById('assinaturaTestemunha2_img').src = 'data:image/png;base64,' + t2;

			// espelhos visuais da confirmação
			const tipo = document.getElementById('confirmacao_tipo')?.value || '';
			const motivo = document.getElementById('confirmacao_motivoRecusa')?.value || '';
			if (document.getElementById('confirmacao_tipo_view')) document.getElementById('confirmacao_tipo_view').value = tipo;
			if (document.getElementById('confirmacao_motivoRecusa_view')) document.getElementById('confirmacao_motivoRecusa_view').value = motivo;

			// evidências: apenas exibe o JSON para conferência
			const evid = document.getElementById('evidencias_json')?.value || '';
			if (document.getElementById('evidencias_json_view')) document.getElementById('evidencias_json_view').value = evid;

			// parcelas: preenche tabela a partir do JSON
			try {
				const json = document.getElementById('parcelas_json')?.value || '[]';
				const parcelas = JSON.parse(json);
				const tbody = document.querySelector('#tabelaParcelasForm tbody');
				let total = 0;

				// Pegando a data da solicitação e a data atual
				const dataSolicitacao = new Date(document.querySelector('[name="dataSolicitacao"]').value || ''); 
				const dataAtual = new Date(); // Data atual

				console.log('Data Solicitação:', dataSolicitacao);
				console.log('Data Atual:', dataAtual);

				if (Array.isArray(parcelas) && tbody) {
					const diaAtual = dataAtual.getDate();
					let ajustesMeses = 0;
					
					console.log('Dia atual:', diaAtual);
					
					if (diaAtual >= 27 || diaAtual <= 7) {
						ajustesMeses = 1;
						console.log('Ajustando todas as parcelas em +1 mês');
					}

					parcelas.forEach((p, index) => {
						let periodo = p.periodo || '';
						let ano = parseInt(periodo.substring(0, 4), 10);
						let mes = parseInt(periodo.substring(4, 6), 10);

						// Aplicar o ajuste para todas as parcelas se necessário
						if (ajustesMeses > 0) {
								mes += ajustesMeses;
								if (mes > 12) {
										mes = mes - 12;
										ano += 1;
								}
								periodo = `${ano}${mes.toString().padStart(2, '0')}`;
						}

						const tr = document.createElement('tr');
						tr.innerHTML = `
								<td><input type="text" class="form-control" value="${periodo}" readonly></td>
								<td><input type="text" class="form-control text-right" value="${(Number(p.valor || 0)).toFixed(2).replace('.', ',')}" readonly></td>
						`;
						tbody.appendChild(tr);
						total += Number(p.valor || 0);
					});
				}

				document.getElementById('parcelas_total').value = total;
				const totEl = document.getElementById('parcelas_total');
				if (totEl) totEl.value = total.toFixed(2).replace('.', ',');
			} catch (e) {
				console.error('Erro ao processar parcelas:', e);
			}
		})();
	</script>
</body>

</html>